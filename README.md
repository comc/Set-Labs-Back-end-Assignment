# **Set Labs Assignment:** Back-End Transaction Status Monitor

This README describes the set of tools herein for deploying a Go Ethereum (Geth) private node Docker container, a solidity smart contract called NumberBet, a contract monitoring script to log all transactions hitting the deployed contract, and a set of test scripts for submitting and  monitoring pre-configured test transactions to the contract.

### Tested Software and Environments

- Linux (kernel 5.10.79)
- Docker v20.10.10
- Python v3.9.7
- virtualenv v20.4.2

### Python package dependencies

The `web3` Python package is required to execute the script herein, and it is recommended to use and install into a Python virtual environment. For example, from within the project root folder:

```sh
virtualenv ./pyenv
source pyenv/bin/activate
pip install web3
```

## Component Deployment

All commands should be executed from the project root folder.

### Geth Node
---

The private node network resides in the `node/` subfolder, and includes a genesis block configuration description in the file `genesis.json`, a password file for simple (insecure) keyfile authentication for testing, and will also contain the database and keyfiles generated by the node.

The following steps describe how to set up and execute the node.

1. Temporarily deploy a new node with a unique network ID and identity in order to create a new account (in step 2):

    ```sh
    docker run --rm -v $(pwd)/node:/data ethereum/client-go --datadir data --networkid 444111 --identity node --netrestrict 192.168.1.0/24 --nodiscover
    ```

    Leave the node running for step 2.

2. Connect to the running node using a separate terminal to set up an account. For convenience of using the test network, we configure a file `node/pwd.txt` that contains the account passphrase (note that this poses a security risk for non-secured systems and networks):

    ```sh
    docker exec -i <container_id> geth account new --datadir data --password /data/pwd.txt
    ```

    Record the account address output from this step. Once the account is created, the container created in step 1 can be stopped.

3. Update the genesis config JSON at `node/genesis.json` to include the account address and network ID from the previous steps. Note that this configures a proof-of-authority network using clique, approximating the Ethereum mainnet block period and gas limit. Additionally, the account address must not contain the `0x` prefix when pasted into the `extradata` field or under the `alloc` property.

    ```json
    {
        "config": {
            "chainId": 444111,
            "homesteadBlock": 0,
            "eip150Block": 0,
            "eip155Block": 0,
            "eip158Block": 0,
            "byzantiumBlock": 0,
            "constantinopleBlock": 0,
            "petersburgBlock": 0,
            "clique": {
            "period": 14,
            "epoch": 30000
            }
        },
        "difficulty": "1",
        "gasLimit": "8000000",
        "extradata": "0x0000000000000000000000000000000000000000000000000000000000000000<account_address_without_0x_prefix>0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        "alloc": {
                "<account_address_without_0x_prefix>": { "balance": "100000000000000000000" },
        }
    }

    ```

    The default account will be created with a balance of 100 ether (100000000000000000000 wei).

4. Delete the temporary node as follows, but make sure to preserve the `node/keystore` folder:

    ```sh
    rm -r node/geth*
    ```

    This command will delete `node/geth.ipc` and `node/geth/` that were created by the node in step 1.

5. Instantiate a new private node with the genesis block using the `node/genesis.json` created in step 3:

    ```sh
    docker run --rm -v $(pwd)/node:/data ethereum/client-go --datadir data --networkid 444111 --identity node --netrestrict 192.168.1.0/24 init /data/genesis.json
    ```

6. Start the node with RPC server and unlock the default account to enable "mining" blocks. The `CORSDOMAIN` points to an optional external server address that can be supplied to allow cross-origin domain requests to the RPC server e.g., via JS browser queries.

    ```sh
    CORSDOMAIN="http://192.168.1.18" && \
    docker run --rm -p 8545:8545 -p 30303:30303 -v $(pwd)/node:/data ethereum/client-go --datadir data --networkid 444111 --identity node --netrestrict 192.168.1.0/24 --http --http.addr "0.0.0.0" --http.corsdomain "$CORSDOMAIN" --unlock "<account_address>" --mine --allow-insecure-unlock --password /data/pwd.txt --nodiscover
    ```

6. Configure the convenience file `node/config.json` used for loading the provider for `web3` applications in the accompanying Python scripts with the appropriate chainId, port, and local server URL hosting the containerised node.

### Build and Deploy Smart Contract
---

The Solidity smart contract *NumberBet* is located in the `solidity/` subfolder, along with a Python script to deploy the contract onto the blockchain.

The contract is created by sending a starting balance of ether to the contract, after which anyone can call the function `placeBet()` with a guess between the numbers 1 and 10 inclusive, along with a transaction value in ether between (0, contract balance / 10]. If a random number generated by the contract matches the guess, the contract pays out 10x the transaction value.

1. The contract can be compiled using the following Docker command:

    ```sh
    docker run --rm -v $(pwd)/solidity/NumberBet:/sources ethereum/solc:stable -o /sources/output --abi --bin /sources/NumberBet.sol --overwrite
    ```

2. The script `solidity/deploy_sc.py` can be used to deploy the smart contract. Refer to the embedded help for usage:

    ```sh
    python solidity/deploy_sc.py -h
    ```

3. On success, the deployment will return the transaction receipt with `'status': 1`. Record the contract address, as it is required to interact with the contract.

### Run Test Suite
---

A suite of test cases are provided along with a stand-alone script for interacting with the smart contract.

1. Execute a stand-alone transaction:

    Use the `tests/submit_bet.py` script to send a single transactional bet to the contract. See the embedded help for usage:

    ```sh
    python tests/submit_bet.py -h
    ```

2. Execute the series of test transactions:

    Use the `tests/run_tests.py` script to execute a sequential series of transactions to the contract to test and monitor its output. See the embedded help for usage:

    ```sh
    python tests/run_tests.py -h
    ```

### Contract Monitor
---

An additional monitoring script is provided `monitor/monitory.py` that can be executed in order to continuously monitor the node block activity for all contract-related transactions.

Refer to the embedded help for usage:

```sh
python monitor/monitor.py -h
```